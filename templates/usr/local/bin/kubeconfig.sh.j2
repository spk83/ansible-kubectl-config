#!/usr/bin/env bash

KUBECTL_CONFIG="{{kubectl_config_install_dir}}/kubectl --kubeconfig {{kubectl_config_dir}}/{{k8s_cluster_name}}-config config"

$KUBECTL_CONFIG \
	set-cluster {{k8s_cluster_name}} \
	--certificate-authority={{k8s_pki_ca_cert_src}} \
	--server={{k8s_apiserver_prefix}}://{{hostvars[k8s_apiserver_first_master]['ansible_' + k8s_network_iface]['ipv4']['address']}}:{{k8s_apiserver_secure_port}}

$KUBECTL_CONFIG \
	set-credentials {{kubectl_config_user}} \
	--client-certificate={{k8s_pki_cert_src}} \
	--client-key={{k8s_pki_key_src}} \
	--token={{kubectl_config_user_token}}

$KUBECTL_CONFIG \
	set-context {{kubectl_config_context_name}} \
	--cluster={{k8s_cluster_name}} \
	--user={{kubectl_config_user}}

$KUBECTL_CONFIG \
	use-context \
	{{kubectl_config_context_name}}
